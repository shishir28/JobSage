@using System.Net.Http.Json
@using JobSage.UI.Models
@using JobSage.UI.Services
@inject HttpClient Http
@inject IChatService ChatService

<div class="chat-window">
    <MudPaper Class="pa-4">
        <MudText Typo="Typo.h6">Agent Chat</MudText>
        <MudList T="string">
            @foreach (var msg in messages)
            {
                <MudListItem>@msg</MudListItem>
            }
        </MudList>
        <MudTextField @bind-Value="userInput" Placeholder="Type a message..." />
        <MudButton OnClick="SendMessage" Color="Color.Primary">Send</MudButton>
    </MudPaper>
</div>

@code {
    [Parameter] public JobDto? CurrentJob { get; set; }

    private List<string> messages = new();
    private string userInput = "";

    protected override async Task OnInitializedAsync()
    {
        if (CurrentJob != null)
        {
            messages.Add("Welcome to the chat!");
            messages.Add("");
            messages.Add("");
         
            var response = await ChatService.SendMessageAsync(CurrentJob, "summarization");

            if (!string.IsNullOrWhiteSpace(response))                
                messages.Add(response);
        }
    }


    private async Task SendMessage()
    {
        if (!string.IsNullOrWhiteSpace(userInput))
        {
            messages.Add($"You: {userInput}");
            var response = await Http.PostAsJsonAsync($"/api/chat/{CurrentJob?.Id}", new { message = userInput });
            var reply = await response.Content.ReadAsStringAsync();
            messages.Add($"Agent: {reply}");
            userInput = "";
        }
    }
}